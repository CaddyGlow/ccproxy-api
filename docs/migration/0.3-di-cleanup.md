# Migration Guide: 0.3 DI Cleanup (2025-09-02)

This release tightens dependency injection across the project to eliminate mixed patterns and improve testability.

Key changes

- Container-first DI for core services
  - `ServiceContainer` is the single source of truth for core services.
  - New container registrations include: `HTTPPoolManager`, `ResponseCache`, `ConnectionPoolManager`, and `BinaryResolver`.
  - `StreamingHandler` now requires `HookManager` at construction (no runtime patching).

- Hook manager is required
  - FastAPI dependency `get_hook_manager()` now returns a required `HookManager` from the container.
  - If the hook system isnâ€™t initialized at startup, requests fail fast with 503.

- Deprecated globals removed
  - Removed `ccproxy.services.http_pool.get_pool_manager()` and `close_global_pool_manager()`.
  - Always resolve `HTTPPoolManager` via the container: `container.get_pool_manager()`.

- Bootstrap and configuration
  - Use `ccproxy.api.bootstrap.create_service_container()` during app construction.
  - Use `Settings.from_config(...)` (TOML/env) instead of `get_settings()`.

How to update your code

- Access services via the container
  - Before: `from ccproxy.services.http_pool import get_pool_manager`
  - After: `pool = request.app.state.service_container.get_pool_manager()`

- Obtain HookManager
  - From FastAPI deps: `HookManagerDep` (required), or
  - From container: `request.app.state.service_container.get_service(HookManager)`

- Validate configuration in scripts
  - Before: `from ccproxy.config.settings import get_settings`
  - After: `from ccproxy.config.settings import Settings; Settings.from_config()`

Notes

- The container is attached to `app.state.service_container` as part of app creation.
- Plugins receive a core context that includes the container and hook registry/manager.
- Mixed patterns (globals + DI) are now considered deprecated.

